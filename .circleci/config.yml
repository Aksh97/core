version: 2
jobs:
  build:
    docker:
      - image: moul/kernel-builder:latest
    working_directory: ~/circulate
    environment:
      - SOURCE_BRANCH: eval
      - TARGET_BRANCH: master
    steps:
      - checkout
      - run:
          name: prepare
          command: 'make prepare_output'
      - run:
          name: testCI
          command: 'make testCI'
      - add_ssh_keys:
          fingerprints:
            - "93:fc:d3:f5:33:3d:1d:79:dc:c9:0c:99:78:73:78:19"
      - deploy:
          name: Deploy
          command: |
            if [ $CIRCLE_BRANCH == $SOURCE_BRANCH ]; then
              git config --global user.email "hanx@g.harvard.edu"
              git config --global user.name "Xueyuan Michael Han"
              cd output
              git status
              git add .
              # is there any change
              if ! git diff-index --exit-code --quiet HEAD; then
                echo 'Committing...'
                git commit -a -m "[ci skip] CircleCI's commit ${CIRCLE_SHA1}"
                git push -q https://${GH_TOKEN}@github.com/crimson-unicorn/output.git $TARGET_BRANCH
              else
                echo 'Nothing to commit.'
              fi
            fi
